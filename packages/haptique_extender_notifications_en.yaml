# Haptique Extender - NOTIFICATIONS
# Place this file in: /config/packages/haptique_extender_notifications.yaml

# ============================================
# AUTOMATIONS - NOTIFICATIONS
# ============================================

automation:
  # ========== LEARNING MODE NOTIFICATIONS ==========
  
  # Notification: Learning Mode Activated
  - id: haptique_notify_learning_mode_activated
    alias: "Haptique - Notify Learning Mode Activated"
    description: "Sends a notification when learning mode is activated"
    trigger:
      - platform: event
        event_type: haptique_learning_activated
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸŽ“ Learning Mode Activated"
          message: >
            **Device:** {{ trigger.event.data.device_name }}
            **Command:** {{ trigger.event.data.command_label }}
            
            ðŸ‘‰ Point your remote control at the IR sensor and press the button.
            
            â±ï¸ Mode will automatically stop after capture or after {{ trigger.event.data.timeout }}s.
          notification_id: "haptique_learning_active_{{ trigger.event.data.device_id }}"
    mode: single

  # Notification: Learning Mode Timeout
  - id: haptique_notify_learning_timeout
    alias: "Haptique - Notify Learning Timeout"
    description: "Notification when learning mode expires without capture"
    trigger:
      - platform: event
        event_type: haptique_learning_timeout
    action:
      - service: persistent_notification.create
        data:
          title: "â±ï¸ Learning Mode Timed Out"
          message: >
            No new IR code captured after {{ trigger.event.data.timeout }} seconds.
            
            ðŸ’¡ **Make sure to:**
            - Point the remote control at the IR sensor
            - Press the button firmly
            - Be within 6 feet of the sensor
            
            Try again by reactivating learning mode.
          notification_id: "haptique_learning_timeout"
    mode: single

  # Notification: IR Code Learned Successfully (Learning with context)
  - id: haptique_notify_ir_code_learned_and_saved
    alias: "Haptique - Notify IR Code Learned and Saved"
    description: "Notification when an IR code is captured and saved to DB"
    trigger:
      - platform: event
        event_type: haptique_command_learned
    action:
      - service: persistent_notification.create
        data:
          title: "âœ… Command Learned and Saved"
          message: >
            **Device:** {{ trigger.event.data.device_name }}
            **Command:** {{ trigger.event.data.command_label }}
            
            âœ… **IR code saved to database!**
            
            ðŸ“‹ **Technical details:**
            - Device ID: `{{ trigger.event.data.device_id }}`
            - Command: `{{ trigger.event.data.command_name }}`
            
            ðŸŽ® You can now use it via replay.
          notification_id: "haptique_learned_{{ trigger.event.data.device_id }}_{{ trigger.event.data.command_name }}"
    mode: single

  # Notification: IR Code Captured Manually (without context)
  - id: haptique_notify_ir_code_captured_manual
    alias: "Haptique - Notify IR Code Captured Manual"
    description: "Notification for manual capture (without DB save)"
    trigger:
      - platform: event
        event_type: haptique_ir_captured_manual
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ“¡ IR Code Captured"
          message: >
            IR code captured successfully!
            
            ðŸ“Š **Information:**
            - Count: {{ trigger.event.data.count }} values
            - Frequency: {{ trigger.event.data.freq_khz }} kHz
            - Frames: {{ trigger.event.data.frames }}
            
            ðŸ“‹ **Complete Raw Data:**
            `{{ trigger.event.data.raw_data | join(', ') }}`
            
            ðŸ’¡ To save this command, use the `learn_ir_command` service.
          notification_id: "haptique_ir_captured"
    mode: single

  # Notification: DB Save Error
  - id: haptique_notify_learning_save_error
    alias: "Haptique - Notify Save Error"
    description: "Notification in case of error when saving to DB"
    trigger:
      - platform: event
        event_type: haptique_learning_error
    action:
      - service: persistent_notification.create
        data:
          title: "âŒ Save Error"
          message: >
            Unable to save command to database.
            
            **Possible reasons:**
            - Missing or invalid Device ID
            - Missing command name
            - JSON file access error
            
            Check logs for more details.
          notification_id: "haptique_learning_error"
    mode: single

  # ========== REPLAY NOTIFICATIONS ==========
  
  # Notification: Command Sent Successfully
  - id: haptique_notify_command_sent_success
    alias: "Haptique - Notify Command Sent"
    description: "Notification when an IR command is sent successfully"
    trigger:
      - platform: event
        event_type: haptique_command_sent
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ“¤ Command Sent"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_name = trigger.event.data.command_name %}
            
            **Device:** {{ device_id }}
            **Command:** {{ command_name }}
            
            âœ… IR signal sent successfully!
          notification_id: "haptique_command_sent"
    mode: single

  # Notification: Command Send Error
  - id: haptique_notify_command_send_error
    alias: "Haptique - Notify Command Send Error"
    description: "Notification in case of error when sending a command"
    trigger:
      - platform: event
        event_type: haptique_command_error
    action:
      - service: persistent_notification.create
        data:
          title: "âŒ Command Send Error"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_name = trigger.event.data.command_name %}
            {% set error = trigger.event.data.error | default('Unknown error') %}
            
            **Device:** {{ device_id }}
            **Command:** {{ command_name }}
            
            âš ï¸ **Error:** {{ error }}
            
            **Possible solutions:**
            - Check that the device is turned on
            - Check the network connection
            - Retry sending
          notification_id: "haptique_command_error"
    mode: single

  # Notification: Command Not Found
  - id: haptique_notify_command_not_found
    alias: "Haptique - Notify Command Not Found"
    description: "Notification when a command doesn't exist in the DB"
    trigger:
      - platform: event
        event_type: haptique_command_not_found
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ” Command Not Found"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_name = trigger.event.data.command_name %}
            
            **Device:** {{ device_id }}
            **Command searched:** {{ command_name }}
            
            âŒ This command does not exist in the database.
            
            ðŸ’¡ **Possible actions:**
            - Check the command spelling
            - List available commands with `list_ir_commands`
            - Learn this command with `learn_ir_command`
          notification_id: "haptique_command_not_found"
    mode: single

  # ========== DB MANAGEMENT NOTIFICATIONS ==========
  
  # Notification: Command Deleted
  - id: haptique_notify_command_deleted
    alias: "Haptique - Notify Command Deleted"
    description: "Notification when a command is deleted from the DB"
    trigger:
      - platform: event
        event_type: haptique_command_deleted
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ—‘ï¸ Command Deleted"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_name = trigger.event.data.command_name %}
            
            The command **{{ command_name }}** has been deleted from device **{{ device_id }}**.
            
            âœ… Deletion completed successfully.
          notification_id: "haptique_command_deleted_{{ device_id }}_{{ command_name }}"
    mode: single

  # Notification: Device Deleted
  - id: haptique_notify_device_deleted
    alias: "Haptique - Notify Device Deleted"
    description: "Notification when a device is deleted from the DB"
    trigger:
      - platform: event
        event_type: haptique_device_deleted
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ—‘ï¸ Device Deleted"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_count = trigger.event.data.command_count | default(0) %}
            
            The device **{{ device_id }}** and all its commands ({{ command_count }}) have been deleted.
            
            âœ… Deletion completed successfully.
          notification_id: "haptique_device_deleted_{{ device_id }}"
    mode: single

  # Notification: Command Delete Error
  - id: haptique_notify_delete_command_error
    alias: "Haptique - Notify Command Delete Error"
    description: "Notification in case of error when deleting a command"
    trigger:
      - platform: event
        event_type: haptique_delete_command_error
    action:
      - service: persistent_notification.create
        data:
          title: "âŒ Command Delete Error"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            {% set command_name = trigger.event.data.command_name %}
            
            Unable to delete command **{{ command_name }}** from device **{{ device_id }}**.
            
            **Possible reasons:**
            - The command does not exist
            - The device does not exist
            - JSON file access error
            
            Check logs for more details.
          notification_id: "haptique_delete_error"
    mode: single

  # Notification: Device Delete Error
  - id: haptique_notify_delete_device_error
    alias: "Haptique - Notify Device Delete Error"
    description: "Notification in case of error when deleting a device"
    trigger:
      - platform: event
        event_type: haptique_delete_device_error
    action:
      - service: persistent_notification.create
        data:
          title: "âŒ Device Delete Error"
          message: >
            {% set device_id = trigger.event.data.device_id %}
            
            Unable to delete device **{{ device_id }}**.
            
            **Possible reasons:**
            - The device does not exist
            - JSON file access error
            
            Check logs for more details.
          notification_id: "haptique_delete_device_error"
    mode: single

  # ========== CONNECTION NOTIFICATIONS ==========
  
  # Notification: Connection Lost
  - id: haptique_notify_connection_lost
    alias: "Haptique - Notify Connection Lost"
    description: "Notification when connection to device is lost"
    trigger:
      - platform: state
        entity_id: binary_sensor.haptique_extender_wifi_connected
        to: "off"
        for:
          seconds: 30
    action:
      - service: persistent_notification.create
        data:
          title: "âš ï¸ Connection Lost"
          message: >
            Connection to Haptique Extender has been lost.
            
            **Checks:**
            - Is the device powered on?
            - Is the WiFi connection active?
            - Has the IP address changed?
            
            Connection will be automatically restored when the device is available again.
          notification_id: "haptique_connection_lost"
    mode: single

  # Notification: Connection Restored
  - id: haptique_notify_connection_restored
    alias: "Haptique - Notify Connection Restored"
    description: "Notification when connection to device is restored"
    trigger:
      - platform: state
        entity_id: binary_sensor.haptique_extender_wifi_connected
        to: "on"
    condition:
      - condition: template
        value_template: "{{ trigger.from_state.state == 'off' }}"
    action:
      - service: persistent_notification.create
        data:
          title: "âœ… Connection Restored"
          message: >
            Connection to Haptique Extender has been restored.
            
            {% set ip = states('sensor.haptique_extender_wifi_ip') %}
            {% set rssi = states('sensor.haptique_extender_wifi_signal') %}
            
            **Information:**
            - IP: {{ ip }}
            - Signal: {{ rssi }} dBm
            
            The device is operational again! ðŸŽ‰
          notification_id: "haptique_connection_restored"
      # Dismiss the connection lost notification
      - service: persistent_notification.dismiss
        data:
          notification_id: "haptique_connection_lost"
    mode: single
